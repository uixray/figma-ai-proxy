<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Figma AI Proxy - API Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 640px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 6px;
            font-size: 26px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .status-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .status {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status.success { background: #10b981; color: white; }
        .status.error   { background: #ef4444; color: white; }
        .status.loading { background: #f59e0b; color: white; }

        .provider-info {
            font-size: 12px;
            color: #9ca3af;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
        }

        label .hint {
            font-weight: 400;
            color: #9ca3af;
        }

        select, input, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
            background: white;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .response {
            margin-top: 20px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .response h3 {
            margin-bottom: 8px;
            color: #374151;
            font-size: 14px;
        }

        .response pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 14px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
        }

        .target-url {
            margin-bottom: 16px;
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            color: #6b7280;
            word-break: break-all;
        }

        .links {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
        }

        .links a {
            display: inline-block;
            margin-right: 14px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            font-size: 13px;
        }

        .links a:hover {
            text-decoration: underline;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Figma AI Proxy</h1>
        <p class="subtitle">Multi-provider CORS proxy for AI APIs (v2.0.0)</p>

        <div class="status-row">
            <div id="status" class="status loading">Checking server...</div>
            <span id="providerInfo" class="provider-info"></span>
        </div>

        <form id="testForm">
            <!-- Provider Selector -->
            <div class="form-group">
                <label for="provider">Provider</label>
                <select id="provider">
                    <option value="yandex">Yandex Cloud</option>
                    <option value="claude">Anthropic Claude</option>
                    <option value="gemini">Google Gemini</option>
                    <option value="groq">Groq</option>
                    <option value="mistral">Mistral AI</option>
                    <option value="cohere">Cohere</option>
                </select>
            </div>

            <!-- API Key -->
            <div class="form-group">
                <label for="apiKey">API Key <span class="hint" id="apiKeyHint">(Api-Key or Bearer token)</span></label>
                <input type="password" id="apiKey" placeholder="Your API key..." required>
            </div>

            <!-- Folder ID (Yandex only) -->
            <div class="form-group" id="folderIdGroup">
                <label for="folderId">Folder ID <span class="hint">(Yandex Cloud)</span></label>
                <input type="text" id="folderId" placeholder="b1g...">
            </div>

            <!-- Prompt -->
            <div class="form-group">
                <label for="prompt">Prompt</label>
                <textarea id="prompt" required>Hello! Reply in one short sentence.</textarea>
            </div>

            <!-- Target URL preview -->
            <div class="target-url" id="targetUrl">Target: /api/yandex</div>

            <button type="submit" id="submitBtn">Send Request</button>
        </form>

        <div id="response" class="response hidden">
            <h3 id="responseTitle">Response:</h3>
            <pre id="responseContent"></pre>
        </div>

        <div class="links">
            <a href="/api/info" target="_blank">API Info</a>
            <a href="/health" target="_blank">Health Check</a>
        </div>
    </div>

    <script>
        // =====================================================================
        // Provider configurations for the Web UI tester
        // =====================================================================
        const PROVIDER_CONFIGS = {
            yandex: {
                name: 'Yandex Cloud',
                needsFolderId: true,
                apiKeyHint: '(Api-Key or Bearer IAM token)',
                apiKeyPlaceholder: 'Api-Key AQVN... or Bearer t1.9e...',
                buildPath: () => '/api/yandex',
                buildHeaders: (apiKey) => ({
                    'Content-Type': 'application/json',
                    'Authorization': apiKey.startsWith('Api-Key ') || apiKey.startsWith('Bearer ')
                        ? apiKey : `Api-Key ${apiKey}`,
                }),
                buildBody: (prompt, folderId) => ({
                    modelUri: `gpt://${folderId}/yandexgpt-lite/latest`,
                    completionOptions: { stream: false, temperature: 0.7, maxTokens: '500' },
                    messages: [{ role: 'user', text: prompt }],
                }),
                extractText: (data) => data?.result?.alternatives?.[0]?.message?.text,
            },

            claude: {
                name: 'Anthropic Claude',
                needsFolderId: false,
                apiKeyHint: '(starts with sk-ant-...)',
                apiKeyPlaceholder: 'sk-ant-api03-...',
                buildPath: () => '/api/claude/messages',
                buildHeaders: (apiKey) => ({
                    'Content-Type': 'application/json',
                    'Authorization': apiKey.startsWith('Bearer ') ? apiKey : `Bearer ${apiKey}`,
                    'anthropic-version': '2023-06-01',
                }),
                buildBody: (prompt) => ({
                    model: 'claude-3-5-haiku-20241022',
                    max_tokens: 500,
                    messages: [{ role: 'user', content: prompt }],
                }),
                extractText: (data) => data?.content?.[0]?.text,
            },

            gemini: {
                name: 'Google Gemini',
                needsFolderId: false,
                apiKeyHint: '(starts with AIza...)',
                apiKeyPlaceholder: 'AIzaSy...',
                buildPath: (apiKey) => `/api/gemini/models/gemini-2.0-flash:generateContent?key=${encodeURIComponent(apiKey)}`,
                buildHeaders: () => ({
                    'Content-Type': 'application/json',
                }),
                buildBody: (prompt) => ({
                    contents: [{ role: 'user', parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.7, maxOutputTokens: 500 },
                }),
                extractText: (data) => data?.candidates?.[0]?.content?.parts?.[0]?.text,
            },

            groq: {
                name: 'Groq',
                needsFolderId: false,
                apiKeyHint: '(starts with gsk_...)',
                apiKeyPlaceholder: 'gsk_...',
                buildPath: () => '/api/groq/chat/completions',
                buildHeaders: (apiKey) => ({
                    'Content-Type': 'application/json',
                    'Authorization': apiKey.startsWith('Bearer ') ? apiKey : `Bearer ${apiKey}`,
                }),
                buildBody: (prompt) => ({
                    model: 'llama-3.3-70b-versatile',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.7,
                    max_tokens: 500,
                }),
                extractText: (data) => data?.choices?.[0]?.message?.content,
            },

            mistral: {
                name: 'Mistral AI',
                needsFolderId: false,
                apiKeyHint: '(Mistral API key)',
                apiKeyPlaceholder: 'Your Mistral API key...',
                buildPath: () => '/api/mistral/chat/completions',
                buildHeaders: (apiKey) => ({
                    'Content-Type': 'application/json',
                    'Authorization': apiKey.startsWith('Bearer ') ? apiKey : `Bearer ${apiKey}`,
                }),
                buildBody: (prompt) => ({
                    model: 'mistral-small-latest',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.7,
                    max_tokens: 500,
                }),
                extractText: (data) => data?.choices?.[0]?.message?.content,
            },

            cohere: {
                name: 'Cohere',
                needsFolderId: false,
                apiKeyHint: '(Cohere API key)',
                apiKeyPlaceholder: 'Your Cohere API key...',
                buildPath: () => '/api/cohere/chat',
                buildHeaders: (apiKey) => ({
                    'Content-Type': 'application/json',
                    'Authorization': apiKey.startsWith('Bearer ') ? apiKey : `Bearer ${apiKey}`,
                }),
                buildBody: (prompt) => ({
                    model: 'command-r',
                    message: prompt,
                    temperature: 0.7,
                    max_tokens: 500,
                }),
                extractText: (data) => data?.text,
            },
        };

        // =====================================================================
        // DOM elements
        // =====================================================================
        const form = document.getElementById('testForm');
        const statusEl = document.getElementById('status');
        const providerInfoEl = document.getElementById('providerInfo');
        const providerSelect = document.getElementById('provider');
        const apiKeyInput = document.getElementById('apiKey');
        const apiKeyHint = document.getElementById('apiKeyHint');
        const folderIdGroup = document.getElementById('folderIdGroup');
        const folderIdInput = document.getElementById('folderId');
        const promptInput = document.getElementById('prompt');
        const targetUrlEl = document.getElementById('targetUrl');
        const responseEl = document.getElementById('response');
        const responseTitleEl = document.getElementById('responseTitle');
        const responseContent = document.getElementById('responseContent');
        const submitBtn = document.getElementById('submitBtn');

        // =====================================================================
        // Provider UI updates
        // =====================================================================
        function updateProviderUI() {
            const key = providerSelect.value;
            const config = PROVIDER_CONFIGS[key];

            // Show/hide Folder ID field
            folderIdGroup.classList.toggle('hidden', !config.needsFolderId);
            if (config.needsFolderId) {
                folderIdInput.setAttribute('required', '');
            } else {
                folderIdInput.removeAttribute('required');
            }

            // Update hints and placeholders
            apiKeyHint.textContent = config.apiKeyHint;
            apiKeyInput.placeholder = config.apiKeyPlaceholder;

            // Update target URL preview
            const path = config.buildPath('API_KEY');
            targetUrlEl.textContent = `Target: ${path.split('?')[0]}`;

            // Update provider info
            providerInfoEl.textContent = config.name;
        }

        providerSelect.addEventListener('change', updateProviderUI);
        updateProviderUI();

        // =====================================================================
        // Health check
        // =====================================================================
        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();

                if (data.status === 'ok') {
                    statusEl.textContent = 'Server Online (v' + data.version + ')';
                    statusEl.className = 'status success';
                } else {
                    throw new Error('Non-ok status');
                }
            } catch (error) {
                statusEl.textContent = 'Server Offline';
                statusEl.className = 'status error';
                submitBtn.disabled = true;
            }
        }

        checkHealth();

        // =====================================================================
        // Form submit â€” send test request
        // =====================================================================
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const providerKey = providerSelect.value;
            const config = PROVIDER_CONFIGS[providerKey];
            const apiKey = apiKeyInput.value.trim();
            const folderId = folderIdInput.value.trim();
            const prompt = promptInput.value.trim();

            if (!apiKey) return;
            if (config.needsFolderId && !folderId) return;

            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';
            responseEl.classList.add('hidden');

            const startTime = Date.now();

            try {
                const path = config.buildPath(apiKey);
                const headers = config.buildHeaders(apiKey);
                const body = config.needsFolderId
                    ? config.buildBody(prompt, folderId)
                    : config.buildBody(prompt);

                const response = await fetch(path, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body),
                });

                const responseTime = Date.now() - startTime;
                const data = await response.json();

                // Show response
                responseEl.classList.remove('hidden');
                responseContent.textContent = JSON.stringify(data, null, 2);

                // Extract text for display
                const text = config.extractText(data);

                if (!response.ok) {
                    responseTitleEl.textContent = `Error ${response.status} (${responseTime}ms):`;
                    statusEl.textContent = `Error: ${response.status}`;
                    statusEl.className = 'status error';
                } else {
                    responseTitleEl.textContent = `Response (${responseTime}ms)` + (text ? ':' : '');
                    statusEl.textContent = 'Request Successful';
                    statusEl.className = 'status success';

                    if (text) {
                        responseTitleEl.textContent += ` "${text.slice(0, 80)}${text.length > 80 ? '...' : ''}"`;
                    }
                }
            } catch (error) {
                responseEl.classList.remove('hidden');
                responseContent.textContent = `Network error: ${error.message}`;
                statusEl.textContent = 'Request Failed';
                statusEl.className = 'status error';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Request';
            }
        });
    </script>
</body>
</html>
