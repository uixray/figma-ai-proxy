# Обновление прокси на сервере

## Первый раз (свежая установка с GitHub)

Если прокси ещё не установлен на сервере:

```bash
ssh user@твой-сервер
```

```bash
cd ~/apps
git clone https://github.com/uixray/figma-ai-proxy.git
cd figma-ai-proxy
npm install
cp .env.example .env
pm2 start server.js --name "figma-ai-proxy" --time
pm2 save
```

---

## Обновление (когда код уже стоит на сервере)

### Вариант А — одна команда (рекомендуется)

Скопируй и вставь в терминал:

```bash
cd ~/apps/figma-ai-proxy && git pull && npm install && pm2 restart figma-ai-proxy && echo "✅ Готово!" && curl -s http://localhost:3001/health
```

Должен вернуть:
```json
{"status":"ok","service":"figma-ai-proxy","version":"2.0.0","providers":["yandex","claude","gemini","groq","mistral","cohere"],"proxy":{"yandex":"direct","claude":"direct","gemini":"direct","groq":"direct","mistral":"direct","cohere":"direct"}}
```

---

### Вариант Б — по шагам

**Шаг 1. Подключись к серверу**
```bash
ssh user@твой-сервер
```

**Шаг 2. Перейди в папку с прокси**
```bash
cd ~/apps/figma-ai-proxy
```

**Шаг 3. Скачай обновления**
```bash
git pull
```

**Шаг 4. Обнови зависимости (если изменился package.json)**
```bash
npm install
```

**Шаг 5. Перезапусти сервер**
```bash
pm2 restart figma-ai-proxy
```

**Шаг 6. Проверь что всё работает**
```bash
curl http://localhost:3001/health
pm2 logs figma-ai-proxy --lines 20
```

---

## Настройка проксирования через Cloudflare (обход блокировки Gemini)

Если Gemini (или другой провайдер) заблокирован в вашем регионе, можно маршрутизировать запросы через Cloudflare Worker. Worker бесплатен (100k запросов/день) и выполняется на зарубежной ноде Cloudflare.

### Шаг 1. Развернуть Cloudflare Worker

На **локальной машине** (не на сервере):

```bash
# Установи Wrangler (CLI для Cloudflare Workers)
npm install -g wrangler

# Авторизуйся (откроется браузер, бесплатный аккаунт подходит)
wrangler login

# Перейди в папку с воркером
cd cloudflare-worker

# Разверни воркер
npx wrangler deploy
```

Ты получишь URL вида:
```
https://ai-api-proxy.ТВОЁ-ИМЯ.workers.dev
```

Запомни этот URL.

### Шаг 2. Установить секретный токен для Worker

```bash
# Всё ещё в папке cloudflare-worker/
npx wrangler secret put AUTH_TOKEN
```

Введи любой секретный токен. Можно сгенерировать:
```bash
openssl rand -hex 32
```

Запомни этот токен — он понадобится на сервере.

### Шаг 3. Проверить, что Worker работает

```bash
curl -X POST https://ai-api-proxy.ТВОЁ-ИМЯ.workers.dev \
  -H "X-Auth-Token: ТВОЙ-ТОКЕН" \
  -H "X-Target-URL: https://httpbin.org/post" \
  -H "Content-Type: application/json" \
  -d '{"test": true}'
```

Должен вернуть JSON с `"test": true` внутри. Если вернул — Worker работает.

### Шаг 4. Настроить прокси на сервере

Подключись к серверу:

```bash
ssh user@твой-сервер
cd ~/apps/figma-ai-proxy
```

Отредактируй `.env` файл:

```bash
nano .env
```

Добавь строки (замени на свои значения):

```env
# Gemini идёт через Cloudflare Worker
PROXY_GEMINI=worker://ai-api-proxy.ТВОЁ-ИМЯ.workers.dev

# Токен авторизации Worker (должен совпадать с тем, что задал в шаге 2)
PROXY_AUTH_TOKEN=твой-секретный-токен

# Yandex идёт напрямую (он и так работает из РФ)
PROXY_YANDEX=direct
```

Сохрани файл (Ctrl+O, Enter, Ctrl+X в nano).

### Шаг 5. Перезапустить прокси

```bash
pm2 restart figma-ai-proxy
```

### Шаг 6. Проверить, что всё работает

```bash
# Проверь health — должен показать proxy статус
curl -s http://localhost:3001/health | python3 -m json.tool
```

Ожидаемый вывод (обрати внимание на поле `proxy`):
```json
{
    "status": "ok",
    "service": "figma-ai-proxy",
    "version": "2.0.0",
    "providers": ["yandex", "claude", "gemini", "groq", "mistral", "cohere"],
    "proxy": {
        "yandex": "direct",
        "claude": "direct",
        "gemini": "worker → https://ai-api-proxy.ТВОЁ-ИМЯ.workers.dev",
        "groq": "direct",
        "mistral": "direct",
        "cohere": "direct"
    }
}
```

```bash
# Проверь логи — при старте должна быть строка [PROXY]
pm2 logs figma-ai-proxy --lines 10
```

Ожидаемые логи:
```
[PROXY] gemini: routing via worker → https://ai-api-proxy.ТВОЁ-ИМЯ.workers.dev
...
  gemini     → Google Gemini [via worker]
```

---

## Типы проксирования

В `.env` можно указать разные типы прокси для разных провайдеров:

```env
# Cloudflare Worker (бесплатно, без своего VPS)
PROXY_GEMINI=worker://ai-api-proxy.ТВОЁ-ИМЯ.workers.dev

# HTTP/HTTPS прокси (если есть Squid или коммерческий прокси)
PROXY_CLAUDE=http://proxy-host:8080

# SOCKS5 прокси (SSH-тоннель, Dante, и т.д.)
PROXY_GROQ=socks5://127.0.0.1:1080

# Принудительно напрямую (даже если задан глобальный PROXY_URL)
PROXY_YANDEX=direct

# Глобальный прокси для всех провайдеров (если не задан per-provider)
PROXY_URL=worker://ai-api-proxy.ТВОЁ-ИМЯ.workers.dev
```

**Приоритет:** `PROXY_{ПРОВАЙДЕР}` → `PROXY_URL` → напрямую

---

## Пример: SSH-тоннель как SOCKS5 прокси

Если у вас есть VPS за рубежом, можно создать SSH-тоннель:

```bash
# На сервере — создать тоннель (работает в фоне)
ssh -D 1080 -f -N -q user@заграничный-vps
```

Затем в `.env`:
```env
PROXY_GEMINI=socks5://127.0.0.1:1080
```

---

## Если старый прокси работал под именем figma-proxy

При первом обновлении с v1.0.0 → v2.0.0 нужно переключить PM2 процесс:

```bash
cd ~/apps/figma-ai-proxy
git pull
npm install
pm2 stop figma-proxy 2>/dev/null || true
pm2 delete figma-proxy 2>/dev/null || true
pm2 start server.js --name "figma-ai-proxy" --time
pm2 save
```

---

## Если папка называется figma-yandex-proxy

Старое имя папки не мешает — просто используй его:

```bash
cd ~/apps/figma-yandex-proxy   # старое имя папки — ок
git pull
npm install
pm2 restart figma-ai-proxy     # или figma-proxy если не переименовывал
```

---

## Полезные команды

```bash
# Статус процесса
pm2 status

# Логи в реальном времени
pm2 logs figma-ai-proxy

# Перезапуск
pm2 restart figma-ai-proxy

# Текущая версия и статус прокси
curl -s http://localhost:3001/health | python3 -m json.tool

# Список провайдеров
curl -s http://localhost:3001/api/info | python3 -m json.tool
```

---

## Если git pull говорит "Already up to date"

Значит на сервере уже стоит последняя версия. Но можно принудительно перезапустить:

```bash
pm2 restart figma-ai-proxy
```

---

## Устранение проблем

### Gemini всё ещё блокирует после настройки Worker

1. Проверь, что Worker развёрнут и доступен:
   ```bash
   curl -s -o /dev/null -w "%{http_code}" https://ai-api-proxy.ТВОЁ-ИМЯ.workers.dev
   ```
   Должен вернуть `405` (Method Not Allowed — это нормально для GET).

2. Проверь, что `.env` содержит правильные значения:
   ```bash
   cat .env | grep PROXY
   ```

3. Проверь, что PM2 подхватил новый `.env`:
   ```bash
   pm2 restart figma-ai-proxy
   pm2 logs figma-ai-proxy --lines 5
   ```
   В логах должна быть строка `[PROXY] gemini: routing via worker`.

4. Если строки `[PROXY]` нет — `.env` не читается. Убедись, что файл `.env` лежит в корне `figma-ai-proxy/`.

### Worker отвечает 401 Unauthorized

Токен на сервере (`PROXY_AUTH_TOKEN` в `.env`) не совпадает с токеном в Worker. Проверь:
```bash
# На сервере
cat .env | grep PROXY_AUTH_TOKEN

# Обновить токен в Worker (на локальной машине)
cd cloudflare-worker
npx wrangler secret put AUTH_TOKEN
```

### Worker отвечает 500 "AUTH_TOKEN secret is not set"

Ты не установил секрет в Worker. Выполни на локальной машине:
```bash
cd cloudflare-worker
npx wrangler secret put AUTH_TOKEN
```

---

## Репозиторий

https://github.com/uixray/figma-ai-proxy
